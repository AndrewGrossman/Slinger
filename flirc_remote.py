import dash
from dash import html
from dash.dependencies import Input, Output, State
import os
import sys
import subprocess
import socket

cmds = {'1'  :       '0,8958,4411,492,4435,520,2160,516,2164,522,2158,518,2162,524,2156,519,2161,515,2164,522,2158,518,2161,524,2156,520,2160,526,4401,522,4405,518,4408,525,4402,521',
        '2'  : '0,8937,4431,493,2186,490,4438,496,2202,475,2188,498,2183,493,2187,521,2160,495,2185,491,2190,497,2183,514,2167,488,2191,496,2185,491,4437,497,4431,493,4434,521',
        '3'  : '0,8935,4432,510,4418,497,4430,494,2186,490,2190,496,2184,492,2188,488,2192,495,2185,491,2189,497,2182,493,2187,489,2191,495,4432,492,2189,498,4429,494,4433,491',
        '4'  : '0,8936,4434,490,2190,497,2184,493,4436,488,2193,495,2185,491,2190,497,2183,494,2187,489,2191,496,2185,491,2189,498,2182,494,2187,489,2191,496,4432,492,4436,489',
        '5'  : '0,8931,4433,490,4437,496,2183,493,4434,489,2190,496,2183,492,2188,488,2191,495,2185,490,2189,497,2182,493,2186,490,2190,495,4431,492,4434,489,2191,495,4431,491',
        '6'  : '0,8959,4408,526,2154,522,4406,518,4411,524,2156,520,2160,527,2153,523,2158,518,2162,525,2155,521,2160,516,2164,522,2157,526,2154,525,4402,522,2158,518,4409,525',
        '7'  : '0,8935,4433,492,4436,498,4430,494,4434,490,2206,480,2184,492,2188,488,2192,495,2186,490,2190,496,2184,492,2188,488,2193,494,4434,490,2190,496,2184,492,4436,488',
        '8'  : '0,8961,4405,528,2152,525,2155,521,2160,526,4401,522,2158,518,2162,525,2155,521,2159,517,2164,523,2157,519,2161,526,2155,521,2159,517,2163,524,2156,520,4408,526',
        '9'  : '0,8934,4465,458,4494,440,2184,492,2188,488,4440,495,2184,491,2189,497,2183,493,2187,489,2191,495,2184,492,2189,497,2182,493,4435,489,4439,495,4432,492,2188,499',
        '0'  : '0,8931,4439,495,2186,491,2189,497,2184,493,2187,489,2192,495,2185,491,2189,497,2186,491,2187,489,2191,495,2185,491,2190,497,2183,493,2187,489,2191,495,2186,491',
        'Br1' : '',
        'OK'   : '0,8938,4434,497,4432,489,2192,492,2189,496,2186,488,4441,490,2191,493,2188,496,2185,489,2192,493,2190,494,2185,490,2191,493,2188,496,4433,498,4431,489,4440,490',
        'Up'   : '0,8930,4436,498,2182,494,2186,489,4439,495,2185,491,4435,498,4430,493,2186,490,2190,496,2184,491,2189,497,2182,494,2186,490,4436,497,2183,493,2187,489,4438,495',
        'Down' : '0,8937,4432,492,4437,498,2182,494,4435,490,2190,497,4431,493,4435,489,2191,496,2185,491,2189,497,2183,503,2177,489,2191,496,2184,492,2188,498,2183,493,4435,490',
        'Left' : '0,8935,4432,523,2157,518,4409,525,4403,521,2159,517,4411,523,4404,520,2160,526,2154,522,2158,518,2163,524,2155,521,2159,527,4401,522,4405,519,4408,525,2155,521',
        'Right': '0,8959,4411,524,4405,499,4429,495,4433,491,2189,498,4431,493,4436,490,2191,496,2184,492,2189,498,2182,495,2185,491,2190,497,2183,493,4435,490,4439,496,2184,492',
        'Br2'  : '',
        'Guide': '0,8937,4431,493,2187,488,2192,512,2168,491,2189,497,4431,494,4434,490,2191,496,2185,523,2157,499,2182,494,2186,491,2189,518,4411,493,2188,520,4408,527,4401,523',
        'Last' : '0,8963,4403,520,4407,526,4401,522,2158,518,2161,525,4402,520,2160,526,2153,522,2158,518,2162,524,2155,521,2159,526,2154,522,2158,518,2162,524,4403,520,4407,527',
        'Exit' : '0,8930,4437,497,2183,493,4435,489,2191,495,2186,490,4437,497,2183,493,2188,488,2192,495,2185,491,2189,497,2184,492,2188,488,4440,494,2186,490,4438,503,4424,493',
        'DVR'  : '0,8929,4437,496,4432,492,2188,498,4429,525,4402,521,4406,517,4410,523,2156,519,2161,525,2155,520,2159,516,2164,522,2157,519,2161,524,2155,521,2159,516,2163,523',
        'Br3'  : '',
        'FF'   : '0,8932,4436,498,4430,494,2186,489,4438,496,4431,492,4435,489,2191,495,2185,490,2190,497,2183,493,2187,488,2192,495,2185,490,2190,496,4431,493,2187,489,2191,494',
        'Rew'  : '0,8958,4409,515,2164,522,4405,518,4409,525,4403,521,4407,516,2164,523,2157,550,2130,525,2155,520,2159,517,2163,523,2157,488,4439,494,2186,521,2159,517,2162,523',
        'Play' : '0,8959,4406,527,4400,523,4404,519,2161,525,4401,521,4406,518,2169,517,2156,519,2161,526,2154,522,2158,518,2162,524,2155,521,2160,526,2154,522,4405,518,2161,525',
        'Pause': '0,8964,4403,521,4407,517,4411,523,4404,520,4408,525,4402,522,2158,518,2163,524,2156,520,2160,516,2164,522,2157,519,2162,524,2156,520,2160,516,2164,523,2164,512',
        'Br4'  : '',
        'Ch+'  : '0,8958,4411,522,4406,516,4413,521,2159,516,4413,520,2160,516,2165,489,2191,515,2165,521,2160,516,2165,520,2160,516,2165,520,4408,525,2155,520,4408,524,2157,518',
        'Ch-'  : '0,8960,4408,524,2155,520,2160,525,4403,518,4410,522,2158,517,2163,522,2157,521,2160,522,2157,517,2163,523,2157,517,2162,523,2160,515,2163,522,4405,517,2163,522',
        'PgUp' : '0,8927,4438,495,2183,493,4434,520,2160,515,4412,522,4405,518,4409,524,2156,488,2191,495,2185,491,2189,497,2182,493,2187,489,4438,495,4432,522,2158,497,2182,524',
        'PgDn' : '0,8931,4434,489,4438,496,4431,492,2188,498,4429,524,4403,520,4406,517,2163,522,2157,519,2160,525,2154,521,2159,516,2163,523,2156,519,4407,525,2154,521,2159,517',
        'Br5'  : '',
        'Rec'  : '0,8929,4444,510,4408,495,2184,491,2189,517,2163,493,4433,489,4438,495,2185,522,2157,498,2182,493,2186,489,2191,516,2163,522,2158,518,2161,525,4402,489,4438,496',
        'OnDemand': '0,8958,4403,487,2190,510,4416,490,2188,497,4428,493,4432,489,2190,547,2131,491,2188,497,2181,493,2186,489,2189,516,2163,491,4433,487,2192,493,4431,521,2157,497',
        'Menu' : '0,8930,4434,489,4438,526,2154,491,2188,497,4430,493,4434,488,2191,495,2184,491,2189,497,2182,493,2187,488,2191,495,2203,472,2189,497,4429,493,4433,490,2190,495',
        'Br6'  : '',
        '1920x1080' : '',
        '1280x720' : '',
        'Restart': ''
    }
    
http_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)    
    
def start_http_streamer(cmd_line):
#START /min "c:\Program Files\Python39\python.exe" g:\slingbox\http_stream_server.py  
    SW_MINIMIZE = 6
    info = subprocess.STARTUPINFO()
    info.dwFlags = subprocess.STARTF_USESHOWWINDOW
    info.wShowWindow = SW_MINIMIZE
    print('Starting HTTP Streamer')
    streamer_process = subprocess.Popen(['c:/Program Files/Python39/python.exe', 'g:/slingbox/http_stream_server.py', cmd_line], shell=False, startupinfo=info)
    return streamer_process

def start_flirc_util():
    """ Start the "flirc_util shell" process """
    SW_MINIMIZE = 6
    info = subprocess.STARTUPINFO()
    info.dwFlags = subprocess.STARTF_USESHOWWINDOW
    info.wShowWindow = SW_MINIMIZE
    print('Starting Flirc_util')
    flirc_util_process = subprocess.Popen(['C:/Program Files (x86)/Flirc/flirc_util.exe', 'shell'],
                                        stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell=False, startupinfo=info)
    return flirc_util_process

def send_command_subprocess(flirc_util_process, ir_code):
    """ Send the IR command
        flirc_util_process is a subprocess we already opened by running "flirc_util shell".
        We leave that open so we don't have to spawn a new process for every key press, which
        seems to be noticeably faster on something slow like a Raspberry Pi Zero W
    """
    flirc_cmd = "sendir --ik=15000 --repeat=1 --pattern=%s\n" % ir_code

    print('flirc_command: %s', flirc_cmd)
    flirc_util_process.stdin.write(str.encode(flirc_cmd))
    flirc_util_process.stdin.flush()
    response = ''
    while 'Done!' not in response:
        response = str(flirc_util_process.stdout.readline())
        print( 'XXX', response )
    print('Sending IR Message to Slingbox')
    http_sock.sendto( b'\x00\x00\x00\x00\x00\x00\x00\x00', ('127.0.0.1', 10000))

#app = dash.Dash(__name__)
app = dash.Dash(title='TV Remote', url_base_pathname='/Remote/')

flirc_util_process = start_flirc_util()
streamer_process = start_http_streamer('1280x720')
buttons = []
callbacks = []
for button in cmds.keys():
    if 'Br' in button :
        buttons.append( html.Br())
        buttons.append( html.Br())
        buttons.append( html.Br())
#        print('Added Break')
    else:
        buttons.append( html.Button( button, id=button, style={'font-size': '80px', 'padding': '0px 20px'}))
        callbacks.append ( Input( button, 'n_clicks' ))

app.layout = html.Div( [
                       html.Div(id='div1', children=buttons )
                      ])

@app.callback(
    Output('div1', 'children'), callbacks )
def run_script_onClick(*clicks):
    global streamer_process, flirc_util_process 
    trigger = dash.callback_context.triggered[0] 
    id = trigger["prop_id"].split(".")[0]
    print('[DEBUG]', id)

    if id not in cmds.keys(): return dash.no_update

    if id == 'Restart' :
        flirc_util_process.kill()
        os.system('taskkill /f /pid %d /t' % streamer_process.pid )
        os.system('taskkill /f /pid %d /t' % os.getpid())
    elif id == '1920x1080' or id == '1280x720' :
        os.system('taskkill /f /pid %d /t' % streamer_process.pid )
        streamer_process = start_http_streamer(id)
    else:
        send_command_subprocess(flirc_util_process, cmds.get(id))

    # convert bytes to string  
    
    return dash.no_update
            
if __name__ == "__main__":
    app.run_server(host='0.0.0.0', port=8888, debug=False)
